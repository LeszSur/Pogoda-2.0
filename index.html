<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <script src="chart/chart.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  
  <link rel="stylesheet" href="style.css">
  <title>Pogodynka</title>
</head>

<body>
  <section id="wybor">
    <canvas id="field1" height="15" width="500"></canvas>
    <p>Wpisz miasto:</p>
    
    <input id="szukaj"></input>
    <button id="przyciskSzukaj">Znajdź</button>
    <select id="wpisyMiast"></select>
    <button id="przyciskUsun">Usuń wpisy</button>
  </section>

  <section>
  <h1 id="naglowek">Pogoda aktualna</h1>
  <div id="loader" class="loader">
    <img src="img/loading.svg" />
  </div>
  </section>

  <section>
    <div class="pogodaAktualna"> 
      <div>Temp. odczuwalna: <span class="temp_od"></span></div>
      <div>Ciśnienie: <span class="cisnienie"></span></div>
      <div>Powietrze: <span class="powietrze"></span></div>
      <div>Wiatr: <span class="wiatr"></span>
      <table>
        <tr><td id="wiatrAktualna">
        </td></tr>
      </table></div>
    </div>
    <div>
      <h1 id="opisAktualna"></h1>
      <h1 id="temp"></h1>
    </div>
    <div>
      <canvas id="obrazekAktualna" height="150" width="300"></canvas>
    </div>
  </section>

  <h3>Prognoza godzinowa:</h3>
  <section>
  <div class="chart-cnt">
    <canvas id="myChart" width="1040" height="200"></canvas>
    <canvas id="ico" width="1040" height="55"></canvas>
  </div>
  </section>
  <section>
    <div>
    <canvas id="tempg1" width="94" height="20"></canvas>
    <canvas id="tempg2" width="94" height="20"></canvas>
    <canvas id="tempg3" width="94" height="20"></canvas>
    <canvas id="tempg4" width="94" height="20"></canvas>
    <canvas id="tempg5" width="94" height="20"></canvas>
    <canvas id="tempg6" width="94" height="20"></canvas>
    <canvas id="tempg7" width="94" height="20"></canvas>
    <canvas id="tempg8" width="94" height="20"></canvas>
  </div>
</section>
<h3>Prognoza na najbliższe 3 dni:</h3>
  <section>
    <div id="panel">
      <h2 id="jutro"></h2>
      <canvas id="obrazekJutro" height="90"></canvas>
      <h2 id="opisJutro"></h2>
      <div class="pogodaJutro">
        <h2><span class="temp"></span></h2>
        <div>Wiatr: <span class="wiatr"></span>
        <table>
          <tr><td id="wiatrJutro">
          </td></tr>
        </table></div>

      </div>

    </div>
    <div id="panel">
      <h2 id="pojutrze"></h2>
      <canvas id="obrazekPojutrze" height="90"></canvas>
      <h2 id="opisPojutrze"></h2>
      <div class="pogodaPojutrze">
        <h2><span class="temp"></span></h2>
        <div>Wiatr: <span class="wiatr"></span>
        <table>
          <tr><td id="wiatrPojutrze">
          </td></tr>
        </table></div>
      </div>
    </div>
    <div id="panel">
      <h2 id="zaTrzy"></h2>
      <canvas id="obrazekZa3" height="90"></canvas>
      <h2 id="opisZa3"></h2>
      <div class="pogodaZa3">
        <h2><span class="temp"></span></h2>
        <div>Wiatr: <span class="wiatr"></span>
        <table>
          <tr><td id="wiatrZa3">
          </td></tr>
        </table></div>
      </div>
    </div>
  </section>

  <div>
    <p id="foot">Pogodynka LeszSur v2.1 - data.source: geoapify.com & openweathermap.org</p>
  </div>


  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">



    let elementTerazNaglowek = document.querySelector("#naglowek");
    let elementTerazOpis = document.querySelector("#opisAktualna");
    let elementTerazTemp = document.querySelector("#temp");
    let elementTerazTempO = document.querySelector(".pogodaAktualna .temp_od");
    let elementTerazCisnienie = document.querySelector(".pogodaAktualna .cisnienie");
    let elementTerazPowietrze = document.querySelector(".pogodaAktualna .powietrze");
    let elementTerazWiatr = document.querySelector(".pogodaAktualna .wiatr");

    let elementGodzinowa1 = document.querySelector(".pogodaGodzinowa .g1 #godz1");
    let elementGodzinowa2 = document.querySelector(".pogodaGodzinowa .g2 #godz2");
    let elementGodzinowa3 = document.querySelector(".pogodaGodzinowa .g3 #godz3");
    let elementGodzinowa4 = document.querySelector(".pogodaGodzinowa .g4 #godz4");
    let elementGodzinowa5 = document.querySelector(".pogodaGodzinowa .g5 #godz5");

    let elementGodzinowaT1 = document.querySelector(".pogodaGodzinowa .g1 #temp1");
    let elementGodzinowaT2 = document.querySelector(".pogodaGodzinowa .g2 #temp2");
    let elementGodzinowaT3 = document.querySelector(".pogodaGodzinowa .g3 #temp3");
    let elementGodzinowaT4 = document.querySelector(".pogodaGodzinowa .g4 #temp4");
    let elementGodzinowaT5 = document.querySelector(".pogodaGodzinowa .g5 #temp5");

    let elementGodzinowaO1 = document.querySelector(".pogodaGodzinowa .g1 #opis1");
    let elementGodzinowaO2 = document.querySelector(".pogodaGodzinowa .g2 #opis2");
    let elementGodzinowaO3 = document.querySelector(".pogodaGodzinowa .g3 #opis3");
    let elementGodzinowaO4 = document.querySelector(".pogodaGodzinowa .g4 #opis4");
    let elementGodzinowaO5 = document.querySelector(".pogodaGodzinowa .g5 #opis5");

    let elementGodzinowaW1 = document.querySelector(".pogodaGodzinowa .g1 #wiatr1");
    let elementGodzinowaW2 = document.querySelector(".pogodaGodzinowa .g2 #wiatr2");
    let elementGodzinowaW3 = document.querySelector(".pogodaGodzinowa .g3 #wiatr3");
    let elementGodzinowaW4 = document.querySelector(".pogodaGodzinowa .g4 #wiatr4");
    let elementGodzinowaW5 = document.querySelector(".pogodaGodzinowa .g5 #wiatr5");
  
    let elementJutroOpis = document.querySelector("#opisJutro");
    let elementJutroTemp = document.querySelector(".pogodaJutro .temp");
    let elementJutroZachmurzenie = document.querySelector(".pogodaJutro .zachmurzenie");
    let elementJutroWiatr = document.querySelector(".pogodaJutro .wiatr");

    let elementPojutrzeOpis = document.querySelector("#opisPojutrze");
    let elementPojutrzeTemp = document.querySelector(".pogodaPojutrze .temp");
    let elementPojutrzeZachmurzenie = document.querySelector(".pogodaPojutrze .zachmurzenie");
    let elementPojutrzeWiatr = document.querySelector(".pogodaPojutrze .wiatr");

    let elementZa3Opis = document.querySelector("#opisZa3");
    let elementZa3Temp = document.querySelector(".pogodaZa3 .temp");
    let elementZa3Zachmurzenie = document.querySelector(".pogodaZa3 .zachmurzenie");
    let elementZa3Wiatr = document.querySelector(".pogodaZa3 .wiatr");

    let miasta = [];
    let putStorage = [];
    let nowyWpisMiasta = document.querySelector(".wpisyMiast");
    let szukaj = "";
     let myLineChart;

    const czasPomiaru = new Date();
    const dzienPomiaru = czasPomiaru.getDay();
    const godzinaPomiaru = czasPomiaru.getHours();
    
    wstawDzień("#jutro", dzienPomiaru + 1);
    wstawDzień("#pojutrze", dzienPomiaru + 2);
    wstawDzień("#zaTrzy", dzienPomiaru + 3);



    function wstawDzień (sitePos, select){

      switch (select) {
        case 1: document.querySelector(sitePos).innerHTML = "poniedziałek";
          break;
        case 2: document.querySelector(sitePos).innerHTML = "wtorek";
          break;
        case 3: document.querySelector(sitePos).innerHTML = "środa";
          break;
        case 4: document.querySelector(sitePos).innerHTML = "czwartek";
          break;
        case 5: document.querySelector(sitePos).innerHTML = "piątek";
          break;
        case 6: document.querySelector(sitePos).innerHTML = "sobota";
          break;
        case 7: document.querySelector(sitePos).innerHTML = "niedziela";
          break;
        case 8: document.querySelector(sitePos).innerHTML = "poniedziałek";
          break;
        case 9: document.querySelector(sitePos).innerHTML = "wtorek";
          break;
    };
  };


 
    function lista(wpisMiasta) {
      let nowyWpisMiasta = document.createElement("option");
      nowyWpisMiasta.value = wpisMiasta;
      nowyWpisMiasta.innerHTML = wpisMiasta;
      document.querySelector("#wpisyMiast").appendChild(nowyWpisMiasta);
    };


    function wstawObrazek(select, sitePos, startPos, size) {

    const canvas = document.querySelector(sitePos);
    const ctx = canvas.getContext("2d");
    const image = new Image();

    image.addEventListener("load", e => {
      ctx.clearRect(startPos, 0, size, size);
      ctx.drawImage(image, startPos, 0, size, size);
    });
    switch (select) {
      case "01d": image.src = "img/slonce.png";
        break;
      case "01n": image.src = "img/slonce.png";
        break;
      case "02d": image.src = "img/chmury1.png";
        break;
      case "02n": image.src = "img/chmury1.png";
        break;
      case "03d": image.src = "img/chmury2.png";
        break;
      case "03n": image.src = "img/chmury2.png";
        break;
      case "04d": image.src = "img/chmury3.png";
        break;
      case "04n": image.src = "img/chmury3.png";
        break;
      case "09d": image.src = "img/deszcz2.png";
        break;
      case "09n": image.src = "img/deszcz2.png";
        break;
      case "10d": image.src = "img/deszcz1.png";
        break;
      case "10n": image.src = "img/deszcz1.png";
        break;
      case "11d": image.src = "img/burza.png";
        break;
      case "11n": image.src = "img/burza.png";
        break;  
      case "13d": image.src = "img/snieg.png";
        break;
      case "13n": image.src = "img/snieg.png";
        break;
      case "50d": image.src = "img/mgla.png";
        break;
      case "50n": image.src = "img/mgla.png";
        break;
      };
    };


    function ustawWiatr(parRotate, parSelector) {
      const obrot = 'rotate('+ parRotate +'deg)';
      document.querySelector(parSelector).innerHTML = "<img src='img/wiatr.png' width=35>";
      document.querySelector(parSelector).style.transform = obrot;
    } 

    function getCoordinates(parCity) {
            let adresCoordinates = "https://api.geoapify.com/v1/geocode/search?text=" + parCity + "&apiKey=5c1152da60b54e39b1f6e5dac9596307";
            fetch(adresCoordinates)
            .then(res => res.json())
            .then(res => { 
                lon = parseFloat(res.features[0].geometry.coordinates[0]);
                lat = parseFloat(res.features[0].geometry.coordinates[1]);
                getWeather(lat, lon);
            })
          }
          
    function getWeather(parLat, parLon){
        let adresWeather = "https://api.openweathermap.org/data/2.5/forecast?lat="+ parLat +"&lon="+ parLon +
                  "&lang=PL&units=metric&appid=992ff55e7b3c5989a38e4ff2e9ff1413";

                
                let wybor;          
                switch (godzinaPomiaru) {

                  case 0 : wybor = 13;
                  break;
                  case 1 : wybor = 13;
                  break;
                  case 2 : wybor = 13;
                  break; 
                  case 3 : wybor = 12;
                  break;
                  case 4 : wybor = 12;
                  break;
                  case 5 : wybor = 12;
                  break;
                  case 6 : wybor = 11;
                  break;
                  case 7 : wybor = 11;
                  break;
                  case 8 : wybor = 10;
                  break;
                  case 9 : wybor = 10;
                  break; 
                  case 10 : wybor = 9;
                  break; 
                  case 11 : wybor = 9;
                  break;
                  case 12 : wybor = 9;
                  break;
                  case 13 : wybor = 8;
                  break; 
                  case 14 : wybor = 8;
                  break;
                  case 15 : wybor = 8;
                  break;
                  case 16 : wybor = 7;
                  break;
                  case 17 : wybor = 7;
                  break;
                  case 18 : wybor = 7;
                  break;
                  case 19 : wybor = 6;
                  break;
                  case 20 : wybor = 6;
                  break;
                  case 21 : wybor = 6;
                  break;
                  case 22 : wybor = 5;
                  break;
                  case 23 : wybor = 5;
                  break;
          
                }

      fetch(adresWeather)
      .then(res => res.json())
      .then(res => { 

          loader.classList.add("visible"); 

          setTimeout(() => {

          loader.classList.remove("visible");

            elementTerazNaglowek.innerHTML = "Pogoda aktualna - " + res.city.name + " " + res.city.country;
            elementTerazOpis.innerHTML = res.list[0].weather[0].description;
            wstawObrazek(res.list[0].weather[0].icon, "#obrazekAktualna", 60, 160);
            ustawWiatr(res.list[0].wind.deg, "#wiatrAktualna");
            elementTerazTemp.innerHTML = Math.round(res.list[0].main.temp) + " °C";
            elementTerazTempO.innerHTML = Math.round(res.list[0].main.feels_like) + " °C";
            elementTerazCisnienie.innerHTML = res.list[0].main.pressure + " hPa";
            elementTerazWiatr.innerHTML = res.list[0].wind.speed + " m/s";

            wstawObrazek(res.list[1].weather[0].icon, "#ico", 10, 49);
            wstawObrazek(res.list[2].weather[0].icon, "#ico", 150, 49);
            wstawObrazek(res.list[3].weather[0].icon, "#ico", 290, 49);
            wstawObrazek(res.list[4].weather[0].icon, "#ico", 430, 49);
            wstawObrazek(res.list[5].weather[0].icon, "#ico", 570, 49);
            wstawObrazek(res.list[6].weather[0].icon, "#ico", 710, 49);
            wstawObrazek(res.list[7].weather[0].icon, "#ico", 850, 49);
            wstawObrazek(res.list[8].weather[0].icon, "#ico", 990, 49);

            tempDraw(res.list[1].main.temp, "#tempg1", 15);
            tempDraw(res.list[2].main.temp, "#tempg2", 15);
            tempDraw(res.list[3].main.temp, "#tempg3", 15);
            tempDraw(res.list[4].main.temp, "#tempg4", 15);
            tempDraw(res.list[5].main.temp, "#tempg5", 15);
            tempDraw(res.list[6].main.temp, "#tempg6", 15);
            tempDraw(res.list[7].main.temp, "#tempg7", 15);
            tempDraw(res.list[8].main.temp, "#tempg8", 15);
            
            elementJutroOpis.innerHTML = res.list[wybor].weather[0].description;
            wstawObrazek(res.list[wybor].weather[0].icon, "#obrazekJutro", 20, 90);
            ustawWiatr(res.list[wybor].wind.deg, "#wiatrJutro");
            elementJutroTemp.innerHTML = Math.round(res.list[wybor].main.temp) + " °C";
            elementJutroWiatr.innerHTML = res.list[wybor].wind.speed + " m/s";

            elementPojutrzeOpis.innerHTML = res.list[wybor+8].weather[0].description;
            wstawObrazek(res.list[wybor+8].weather[0].icon, "#obrazekPojutrze", 20, 90);
            ustawWiatr(res.list[wybor+8].wind.deg, "#wiatrPojutrze");
            elementPojutrzeTemp.innerHTML = Math.round(res.list[wybor+8].main.temp) + " °C";
            elementPojutrzeWiatr.innerHTML = res.list[wybor+8].wind.speed + " m/s";

            elementZa3Opis.innerHTML = res.list[wybor+16].weather[0].description; 
            wstawObrazek(res.list[wybor+16].weather[0].icon, "#obrazekZa3", 20, 90);
            ustawWiatr(res.list[wybor+16].wind.deg, "#wiatrZa3");
            elementZa3Temp.innerHTML = Math.round(res.list[wybor+16].main.temp) + " °C";
            elementZa3Wiatr.innerHTML = res.list[wybor+16].wind.speed + " m/s";
            
          }, 250);

            function Text (parText) {
              let String;
              let ShortString;
              let Temp;
              let TextString;
              String = (res.list[parText].dt_txt);
              ShortString = (String.slice(11, 16));
              return ShortString};

            function Temp (parTemp) {
              let String;
              let TextString;
              String = res.list[parTemp].main.temp;
              TextString = String.toString();
              return TextString};

             function tempDraw (parTempDraw, sitePos, startPos) {
              let tempText = Math.round(parTempDraw) + " °C";
              const canvas = document.querySelector(sitePos);
              const ctx = canvas.getContext("2d");
              ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
              ctx.font = "18px Arial";
              ctx.fillStyle = 'grey';
              ctx.fillText(tempText, 15, startPos)};

      let dataChart = {
            labels: [],
            datasets: [
                 {label: "",
                  borderDash: [3, 3], 
                  borderColor : 'rgba(236,115,87, 0.7)',
                  pointBorderColor : 'rgba(236,115,87, 0.7)',
                  borderWidth : 2,
                  fill: true, 
                  backgroundColor : 'rgba(236,115,87, 0.1)',
                  pointRadius : 4,
                  pointBorderWidth : 1,
                  pointBackgroundColor : 'rgba(255,255,255,1)',
                  pointHoverRadius: 6,
                  pointHoverBorderWidth: 3,
                  pointHoverBackgroundColor : 'rgba(255,255,255,1)',
                  pointHoverBorderColor : 'rgba(236,115,87, 1)',
                  data: [], }
             ]};

              let optionsChart = {
                plugins:{
                  legend:{
                    labels:{
                      generateLabels: "",
                    }
                  }
                }
              };
              

      dataChart.labels = [Text(1), Text(2), Text(3), Text(4), Text(5), Text(6), Text(7), Text(8)];
      dataChart.datasets[0].data = [Temp(1), Temp(2), Temp(3), Temp(4), Temp(5), Temp(6), Temp(7), Temp(8)];


      Chart.defaults.font.size = 18;

      let canvasDraw = document.querySelector("#myChart");

      let ctxDraw = canvasDraw.getContext("2d");

      myLineChart = new Chart(ctxDraw, {
      type: 'line',
      data: dataChart,
      options: optionsChart
      });

            let adresAir = "https://api.openweathermap.org/data/2.5/air_pollution?lat="
                    + parLat +"&lon=" + parLon + "&appid=992ff55e7b3c5989a38e4ff2e9ff1413";
            fetch(adresAir)
            .then(res => res.json())
            .then(res => { 
              if ((res.list[0].components.pm10 >= 180) || (res.list[0].components.pm2_5 >= 110) || (res.list[0].components.no2 >= 400) || (res.list[0].components.o3 >= 240)) {elementTerazPowietrze.innerHTML = "bardzo złe"}
              else if ((180 > res.list[0].components.pm10 > 90.1) || (110 > res.list[0].components.pm2_5 > 55.1) || (400 > res.list[0].components.no2 > 200.1) || (240 >res.list[0].components.o3 > 180.1)) {elementTerazPowietrze.innerHTML = "złe"}
              else if ((90 > res.list[0].components.pm10 > 50.1) || (55 > res.list[0].components.pm2_5 > 30.1) || (200 > res.list[0].components.no2 > 100.1) || (180 >res.list[0].components.o3 > 120.1)) {elementTerazPowietrze.innerHTML = "umiarkowane"}
              else if ((50 > res.list[0].components.pm10 > 25.1) || (30 > res.list[0].components.pm2_5 > 15.1) || (100 > res.list[0].components.no2 > 50.1) || (120 >res.list[0].components.o3 > 60.1)) {elementTerazPowietrze.innerHTML = "dobre"}
              else if ((25 > res.list[0].components.pm10 > 0) || (15 > res.list[0].components.pm2_5 > 0) || (50 > res.list[0].components.no2 > 0) || (60 >res.list[0].components.o3 > 0)) {elementTerazPowietrze.innerHTML = "bardzo dobre"}
                    })
                  })

    .catch(error => document.querySelector("#opisAktualna").innerHTML = "błąd wczytywania danych")
                };


      window.addEventListener("load", () => {
      
      navigator.geolocation.getCurrentPosition((position) => {
        let lon = position.coords.longitude;
        let lat = position.coords.latitude;
        getWeather(lat, lon);
      });
        
        let getStorage = localStorage.getItem("miasta");
                if (getStorage === null) {
                    lista("");
                    miasta.push("");
                    return;}
                else {
            getStorage = JSON.parse(localStorage.getItem("miasta"))       
                   
                    for (i=0; i < getStorage.length; i++) {
                      miasta.push(getStorage[i]);
                      lista(miasta[miasta.length - 1]);}
            }; 
   
    });

      document.querySelector("#wpisyMiast").addEventListener("change", (wybor) => {
              let mojWybor = wybor.target.value;
              myLineChart.destroy();
              getCoordinates(mojWybor);
      });

      document.querySelector("#przyciskSzukaj").addEventListener("click", () => {
              myLineChart.destroy();
              let parCity = document.querySelector("#szukaj").value;
              getCoordinates(parCity);
              miasta.push(parCity);
              lista(parCity);
              localStorage.setItem("miasta", JSON.stringify(miasta));
              document.querySelector("#szukaj").value = "";
      });

      document.querySelector("#przyciskUsun").addEventListener("click", () => {
                let div = document.querySelector("#wpisyMiast"), child;
                while ((child = div.firstChild)) {
                div.removeChild(child);
                };
                miasta.length = 0;
                localStorage.clear();
      });
        
    </script>
</body>

</html>
